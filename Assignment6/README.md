- # Assignment6

  This folder contains all the code written to generate PDSCH DMRS signals according to TS 38.211 using MATLAB.  Further, a receiver is designed for the detection of the transmitted DMRS symbols and channel estimation in the case of a AWGN and TDL channel defined according to TR 38.901.

  Demodulation Reference Signals (DMRS) are used for channel estimation in the 5G NR setup. In this simulation multiport DMRS is generated over a single specified slot. Specifications from the following have been used to develop this code

  - TS 38.211
    - Section 7.4.1.1
    - Section 5.2.1
  - TS 38.214 
    - Section 4.1
    - Section 5.1.2.2.1 
  - TS 38.331

  

  - [Report]()
  - Sample DMRS (description in Contents section)
    - [only_dmrs_config1.mat](https://drive.google.com/file/d/1S5_xz32d2-Br-Ter0VWwcy8FRAKRinZB/view?usp=sharing)
    - [only_dmrs_config2.mat](https://drive.google.com/file/d/1vqG9gWt6C6AtsoN7KBdslFuvPetSekPY/view?usp=sharing)
    - [only_dmras_config3.mat](https://drive.google.com/file/d/1IwV0VNYhV5k591MdzFjx6kvknvFLV1Vr/view?usp=sharing) 

  ## Contents

  The following is a brief summary of the necessary scripts to generate the DMRS symbols

  

  - __PDSCH_DMRS.m__: Main script used to generate the DMRS, transmit it through a specified channel and estimate channel parameters

  - __PDSCH_DMRS_config.m__: Configuration file specifying parameters for the DMRS generation, transmission and channel

  - __test_vector{1/2/3}.m__: Three test configuration files

  - __only_dmrs_config{1/2/3}.mat__: Resource grid (only BWP region) corresponding to test_vector{1/2/3}.m generated by Systemvue

  - __c_sequence.m___: Script to generate the c(n) sequence specified by TS 38.211 5.2.1

  - __Table{1/2/3/4/5}.m__: Scripts to capture the information contained in tables 7.4.1.1.2-{1/2/3/4/5}

  - __nominalRBG_P.m__: Script to capture the information captured in Table 5.1.2.2.1-1 in TS 38.214

  - __estimateChannel.m__: Script to estimate the channel from the transmitted and received DMRS symbols

  - __plotResourceGrid.m__: Function to plot the absolute values of symbols in the resource grid (a 2D array)

  - __TDLChannelTX.m__: Function to pass the time domain data through a TDL channel and perform a perfect estimation of the channel using inbuilt functions

       

  ## Usage

  ### PDSCH_DMRS_config.m

  This is the configuration file that governs the generation of the DMRS symbols.  __The file provides extensive documentation regarding each parameter.__ However, this section offers some details of how to modify the configuration files. 

  - __Numerology__: The configuration uses the parameter __mu__. SCS = $2^{mu} \times 15$ kHz.

  - __PDSCH_DMRS_Length__: In the supplied test vectors, this determines if it is a single or double symbol DMRS. The configuration file makes use of the following

    - Setting __maxLength__ to "len1" or "not configured" uses single symbol DMRS.
    - Setting __maxLength__ to "len2" uses the value of __DCI_dmrs_len__ to determine the DMRS length. Setting __DCI_dmrs_len__ to "double" uses double symbol dmrs and "single" uses single symbol DMRS.

  - __Generating__ $\beta_{PDSCH}^{DMRS}$: To generate this value, it is assumed that __PDSCH_PowerBoosting__ refers to PDSCH EPRE in dB and __PDSCH_DMRS_PowerBoosting__ to the DMRS EPRE. 

  - __Multiport transmission__: DMRS and data symbols can be transmitted over multiple ports. However, port selection has to be made according to **Table 7.4.1.1.2-5 from TS 38.211**.

  - __Data__: Symbols other than the DMRS are filled with QAM symbols. Three types of filling are allowed

    - *Zero*: Where all the free symbols are set to zero.
    - *All*: Where all the free symbols are set to some QAM symbols
    - *Isolated*: Symbols are filled such that there is no interference between data symbols from one CDM group and DMRS symbols of another CDM group.

  - __SNR__: This can be adjusted using the SNR variable in the script and affects the noise level of the AWGN.

  - __AWGN transmission__: A simple AWGN channel model can be used instead of the TDL channel model by setting *channelType* to "AWGN". However, for this the variables **PortsNum must be equal to NumReceiveAntennas**.

    

  __NOTE__: For users of Systemvue, the parameter names used by Systemvue and the configuration files are not fully identical. However, the similarity and associated comments should be able indicate the purpose with sufficient clarity.

  ### PDSCH_DMRS.m

  The file can be run as usual in MATLAB. It expects the ```Table{1/2/3/4/5}.m``` , ```c_sequence.m```, ```nominalRBG_P.m```, ``` estimateChannel.m```, ```plotResourceGrid.m``` and the ```TDLChannelTX.m``` files to be present in the same directory. The configuration can be specified in the format described by ```PDSCH_DMRS_config.m```. The exact filename can be specified in the ```run``` function given in the __Defining variables__ section of the code shown below

  ```
  %%
  clear; clc;
  
  %% Defining variables
  
  run("PDSCH_DMRS_config.m");
  % run("test_vector1.m");
  % run("test_vector2.m");
  % run("test_vector3.m");
  
  ```

  Removing the comment from any of the ```run("test_vector{1/2/3}.m")``` statement will produce the output corresponding to one of the sample configurations supplied. The accuracy of the results produced for any of the test vectors can also be verified using the __Verifying accuracy__ section of the code shown below

  ``` %% Verifying accuracy
  % filename = "only_dmrs_config1.mat";
  % filename = "only_dmrs_config2.mat";
  % filename = "only_dmrs_config3.mat";
  tfGrid = load(filename);
  loaded = tfGrid.output;
  % 
  dims = size(loaded);
  accuracy = sum(sum(loaded == multiport_RG_DMRS_output))/(dims(1)*dims(2)) 
  ```

  To compare the output generated with the __only_dmrs_config{1/2/3}.mat__ file, remove the comment from the appropriate line. 

  __NOTE:__ This accuracy measurement only applies to the supplied test vectors and not to other files. It must be commented out when running any other configuration!

  Other configurations can be specified by modifying the ```PDSCH_DMRS_config.m``` file and choosing to run that file.

  Both timing offset estimation and delay estimation are performed. Once the channel is estimated at the positions where the DMRS is transmitted, **linear interpolation** is used to obtain the channel for the remaining positions in the resource grid. The error matrix is normalized by the Frobenius norm of the theoretical channel.

  __Note 1__: This implements DMRS generation only for a single slot as data can be generated for multiple slots by running the script multiple times. This is obtained using __PDSCH_AllocatedSlots__.

  __Note 2__: Some parts of the specifications are not pertinent to the implementation as higher layer information or clashing CORESET information is not present and hence are not simulated.

  #### Outputs

  The ```PDSCH_DMRS.m``` file produces the following outputs

  - __Plots__ (display): These are heatmaps of the resource grid (only active BWP) displaying the theoretical channel (obtained using inbuilt functions) and the estimated channel. A 3D plot of the MSE for the estimated channel across the grid (in the range of those subcarriers where  DMRS was transmitted).
  - __DMRS_output.mat__: A .mat file with the generated DMRS symbols and the estimated channel. The data is saved with the variable name __multiport_RG_DMRS_output__ of dimension (BWP_size, 14, num. of Ports). The estimated channel data is named as **channelEstimate**. The output .mat file can be renamed by changing the __outputFilename__ parameter in ```PDSCH_DMRS_config.m.```

  #### Useful links

  - [Using nrChannelEstimate](https://www.mathworks.com/help/5g/ref/nrchannelestimate.html#mw_fc960c7c-87bb-4b37-b1b0-36673d08c97c)

  